# Utils 模块

此模块包含应用程序的各种工具类和服务，提供数据转换、AI 解析、日志管理和其他辅助功能。这些工具为整个应用程序提供基础设施支持。

## 功能概述

- **数据转换**: 处理文本到结构化数据的转换
- **AI服务**: 提供智能解析和自然语言处理能力
- **日志管理**: 统一的日志记录和管理系统
- **工具函数**: 常用的辅助函数和实用工具

## 文件列表及功能

### `data_converter.py`
- **核心类**: `DataConverter`
- **主要功能**:
  - 文本到日期信息的解析转换
  - 文本到优先级信息的提取
  - 支持多种日期格式（今天、明天、具体日期等）
  - 支持多种优先级标识符（#紧急、#urgent、#重要等）
- **转换能力**:
  - 自然语言日期：今天、明天、后天、下周等
  - 具体日期格式：2024-01-15、01/15等
  - 优先级关键词：紧急、重要、普通等
  - 类别标识符：#工作、#生活、#学习等

### `ai_service.py` ⭐ 核心AI功能
- **核心类**: 
  - `GeminiService`: AI 服务主类
  - `TodoItemAI`: AI 解析结果数据模型（Pydantic）
  - `PriorityLevel`: 优先级枚举
  - `CategoryType`: 类别枚举
- **主要功能**:
  - 自然语言文本的智能解析
  - 结构化数据提取（使用 Gemini 结构化输出）
  - 智能优先级和类别识别
  - 时间信息的智能解析
  - 完善的错误处理和回退机制
- **技术特点**:
  - 使用 Google Generative AI (Gemini 1.5 Flash)
  - 支持 Pydantic 模型验证
  - 自动 JSON 解析和对象转换
  - 环境变量配置管理

### `ai_converter.py`
- **核心类**: `AIConverter`
- **主要功能**:
  - 将 AI 解析结果转换为应用程序的 TodoItem 格式
  - 提供优先级映射（AI 枚举 → 应用程序枚举）
  - 实现类别映射（AI 分类 → 应用程序分类）
  - 处理日期转换（字符串日期 → QDate 对象）
- **转换映射**:
  - AI 优先级 → 应用优先级
  - AI 类别 → 应用类别
  - 字符串日期 → Qt日期对象

### `logger.py`
- **核心类**: `ModuleLogger`
- **主要功能**:
  - 提供统一的日志管理接口
  - 支持按模块分类的日志记录
  - 实现日志级别控制和格式化
  - 提供文件和控制台双重输出
- **日志功能**:
  - 分级日志记录（DEBUG、INFO、WARNING、ERROR、CRITICAL）
  - 模块化日志管理
  - 日志文件轮转
  - 性能监控支持

## 数据流向架构

```
用户输入自然语言
        ↓
   AI Service 解析
        ↓
   AI Converter 转换
        ↓
   TodoItem 对象
        ↓
   Model 层存储

普通结构化输入
        ↓
   Data Converter 解析
        ↓
   TodoItem 对象
        ↓
   Model 层存储
```

## 依赖关系

### 外部依赖
- `google-generativeai`: Google Gemini AI 客户端库
- `pydantic`: 数据验证和模型定义
- `python-dotenv`: 环境变量管理
- `PySide6.QtCore`: Qt日期时间对象

### 内部依赖
- `model/todo_model`: 应用程序数据模型
- `config/`: 配置文件访问

### 被依赖关系
- `controller/`: 使用AI服务和数据转换功能
- `model/`: 使用日志记录功能
- `view/`: 使用工具函数

## AI服务详细说明

### Gemini API集成
- **模型**: Gemini 1.5 Flash
- **输入**: 自然语言文本
- **输出**: 结构化的TodoItemAI对象
- **优势**: 高准确度的意图识别和信息提取

### 智能解析能力
- **时间识别**: "明天下午3点开会" → 具体日期时间
- **优先级判断**: "紧急处理客户投诉" → 高优先级
- **类别分类**: "完成项目报告" → 工作类别
- **任务提取**: "记得买牛奶和面包" → 两个独立任务

### 错误处理机制
- **网络异常**: 自动重试 + 降级到传统解析
- **API限制**: 请求频率控制 + 缓存机制
- **格式错误**: JSON解析失败处理 + 默认值填充
- **服务不可用**: 优雅降级到关键词匹配

## 数据转换详细说明

### 日期解析算法
```python
# 支持的日期格式示例
"今天" → 当前日期
"明天" → 当前日期+1天
"下周五" → 下周五的具体日期
"2024-01-15" → 2024年1月15日
"01/15" → 当年1月15日
```

### 优先级识别规则
```python
# 优先级关键词映射
urgent_keywords = ["紧急", "urgent", "立即", "马上"]
high_keywords = ["重要", "important", "高", "high"]
medium_keywords = ["中等", "medium", "普通"]
low_keywords = ["低", "low", "不急", "有空"]
```

## 日志系统详细说明

### 日志配置
- **文件存储**: `logs/模块名/` 目录下
- **轮转策略**: 按大小轮转，保留历史文件
- **格式化**: 时间戳 + 级别 + 模块 + 消息
- **性能**: 异步写入，避免阻塞主线程

### 使用方式
```python
from utils.logger import module_logger

# 获取模块日志器
logger = module_logger.get_logger('controller')

# 记录不同级别的日志
logger.info('操作成功')
logger.error('操作失败', exc_info=True)
logger.debug('调试信息', extra={'user_id': 123})
```

## 功能互补性

### AI vs 传统解析
- **AI解析**: 处理自然语言，智能识别意图
- **传统解析**: 处理结构化输入，快速可靠
- **协同工作**: AI失败时自动降级到传统解析

### 数据转换链
- **统一接口**: 不同解析方式最终都生成TodoItem对象
- **格式标准化**: 确保数据格式一致性
- **验证机制**: 多层验证确保数据质量

## 配置管理

### 环境变量
```bash
# AI服务配置
GEMINI_API_KEY=your_api_key_here

# 日志配置
LOG_LEVEL=INFO
LOG_FILE_SIZE=10MB
LOG_BACKUP_COUNT=5
```

### 配置文件
```json
{
  "ai_service": {
    "model": "gemini-1.5-flash",
    "temperature": 0.3,
    "max_tokens": 1000
  },
  "data_converter": {
    "date_formats": ["today", "tomorrow", "%Y-%m-%d"],
    "priority_keywords": {...}
  }
}
```

## 性能优化

### AI服务优化
- **请求缓存**: 相似请求复用结果
- **批量处理**: 多个请求合并处理
- **超时控制**: 避免长时间等待
- **降级策略**: 服务不可用时的处理

### 数据转换优化
- **正则预编译**: 提高匹配速度
- **规则缓存**: 避免重复计算
- **并行处理**: 多个转换任务并行
- **内存管理**: 及时释放临时对象

## 扩展性设计

### 插件架构
- **解析器插件**: 支持自定义解析逻辑
- **转换器插件**: 支持新的数据格式
- **服务插件**: 集成其他AI服务

### 接口标准化
- **统一的解析接口**: 便于添加新的解析方式
- **标准的输出格式**: 确保兼容性
- **配置化规则**: 支持动态调整解析规则

## 测试支持

### 单元测试
- **Mock AI服务**: 避免真实API调用
- **数据驱动测试**: 大量测试用例验证
- **边界条件测试**: 异常输入处理

### 集成测试
- **端到端测试**: 完整的解析流程验证
- **性能测试**: 大量数据处理能力
- **兼容性测试**: 不同数据格式支持

## 安全考虑

### API安全
- **密钥管理**: 环境变量存储API密钥
- **请求验证**: 确保请求合法性
- **数据脱敏**: 避免敏感信息泄露

### 数据安全
- **输入验证**: 防止恶意输入
- **输出过滤**: 清理不安全内容
- **日志脱敏**: 避免记录敏感信息 